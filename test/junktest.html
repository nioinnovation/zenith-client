<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://localhost:8181/fusion/fusion.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.0.7/rx.all.js"></script>
  </head>
  <body>
    <script>
     'use strict'
     const Fusion = require('Fusion');
     Fusion.enableLogging();
     const socket = new Fusion.Socket('localhost:8181', false, 'fusion');
     let options = {
         collection: 'foo',
         find: {id: 1}
     };
     let req1 = socket.makeRequest({type: 'query', options });
     let req2 = socket.makeRequest({type: 'subscribe', options });
     let req3 = socket.makeRequest({type: 'insert',
                                    options: { collection: 'foo',
                                               data: [{blam: 2}]}});
     function maker(name, cb) {
         cb = cb? cb : x => x;
         return Rx.Observer.create(
             x => { console.log(`${name} got: `, x); cb() },
             err => console.log(`${name} errored`, err),
             () => console.log(`${name} completed.`)
         )
     }
     let handshake = socket.handshake.subscribe(maker('handshake'));
     let disp1 = req1.subscribe(maker('first'));
     //let disp2 = req2.subscribe(maker('second', () => { disp2.dispose() }));
     let disp3 = req3.subscribe(maker('third', () => socket.onCompleted()));
     // Do a real Fusionconnection here
     const fusion = Fusion('localhost:8181', { secure: false })
     Fusion.enableLogging()
     const foo = fusion('foo')
     foo.insert([{hi: 'there'}, {ho: 'there'}])
        .do(x => console.log('INSERTED:', x))
        .flatMap(id => {
            console.log(`Going to fire off a query for ${id}`)
                return foo.find(id).value().do(() => console.log(`Got result for ${id}`))})
        .do(y => console.log('FOUND:', y))
        .subscribe(
            x => console.log('next'),
            err => console.log('error:', err),
            () => console.log('completed')
        )
    </script>
  </body>
</html>
